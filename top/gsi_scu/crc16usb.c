#include <stdint.h>
#include "crc16usb.h"

// This code assumes that unsigned is 4 bytes.

unsigned crc16usb_bit(unsigned crc, void const *mem, size_t len) {
    unsigned char const *data = mem;
    if (data == NULL)
        return 0;
    crc = ~crc;
    crc &= 0xffff;
    while (len--) {
        crc ^= *data++;
        for (unsigned k = 0; k < 8; k++)
            crc = crc & 1 ? (crc >> 1) ^ 0xa001 : crc >> 1;
    }
    crc ^= 0xffff;
    return crc;
}

#define table_byte table_word[0]

static unsigned short const table_word[][256] = {
   {0xbf40, 0x7f81, 0x7ec1, 0xbe00, 0x7c41, 0xbc80, 0xbdc0, 0x7d01, 0x7941, 0xb980,
    0xb8c0, 0x7801, 0xba40, 0x7a81, 0x7bc1, 0xbb00, 0x7341, 0xb380, 0xb2c0, 0x7201,
    0xb040, 0x7081, 0x71c1, 0xb100, 0xb540, 0x7581, 0x74c1, 0xb400, 0x7641, 0xb680,
    0xb7c0, 0x7701, 0x6741, 0xa780, 0xa6c0, 0x6601, 0xa440, 0x6481, 0x65c1, 0xa500,
    0xa140, 0x6181, 0x60c1, 0xa000, 0x6241, 0xa280, 0xa3c0, 0x6301, 0xab40, 0x6b81,
    0x6ac1, 0xaa00, 0x6841, 0xa880, 0xa9c0, 0x6901, 0x6d41, 0xad80, 0xacc0, 0x6c01,
    0xae40, 0x6e81, 0x6fc1, 0xaf00, 0x4f41, 0x8f80, 0x8ec0, 0x4e01, 0x8c40, 0x4c81,
    0x4dc1, 0x8d00, 0x8940, 0x4981, 0x48c1, 0x8800, 0x4a41, 0x8a80, 0x8bc0, 0x4b01,
    0x8340, 0x4381, 0x42c1, 0x8200, 0x4041, 0x8080, 0x81c0, 0x4101, 0x4541, 0x8580,
    0x84c0, 0x4401, 0x8640, 0x4681, 0x47c1, 0x8700, 0x9740, 0x5781, 0x56c1, 0x9600,
    0x5441, 0x9480, 0x95c0, 0x5501, 0x5141, 0x9180, 0x90c0, 0x5001, 0x9240, 0x5281,
    0x53c1, 0x9300, 0x5b41, 0x9b80, 0x9ac0, 0x5a01, 0x9840, 0x5881, 0x59c1, 0x9900,
    0x9d40, 0x5d81, 0x5cc1, 0x9c00, 0x5e41, 0x9e80, 0x9fc0, 0x5f01, 0x1f41, 0xdf80,
    0xdec0, 0x1e01, 0xdc40, 0x1c81, 0x1dc1, 0xdd00, 0xd940, 0x1981, 0x18c1, 0xd800,
    0x1a41, 0xda80, 0xdbc0, 0x1b01, 0xd340, 0x1381, 0x12c1, 0xd200, 0x1041, 0xd080,
    0xd1c0, 0x1101, 0x1541, 0xd580, 0xd4c0, 0x1401, 0xd640, 0x1681, 0x17c1, 0xd700,
    0xc740, 0x0781, 0x06c1, 0xc600, 0x0441, 0xc480, 0xc5c0, 0x0501, 0x0141, 0xc180,
    0xc0c0, 0x0001, 0xc240, 0x0281, 0x03c1, 0xc300, 0x0b41, 0xcb80, 0xcac0, 0x0a01,
    0xc840, 0x0881, 0x09c1, 0xc900, 0xcd40, 0x0d81, 0x0cc1, 0xcc00, 0x0e41, 0xce80,
    0xcfc0, 0x0f01, 0xef40, 0x2f81, 0x2ec1, 0xee00, 0x2c41, 0xec80, 0xedc0, 0x2d01,
    0x2941, 0xe980, 0xe8c0, 0x2801, 0xea40, 0x2a81, 0x2bc1, 0xeb00, 0x2341, 0xe380,
    0xe2c0, 0x2201, 0xe040, 0x2081, 0x21c1, 0xe100, 0xe540, 0x2581, 0x24c1, 0xe400,
    0x2641, 0xe680, 0xe7c0, 0x2701, 0x3741, 0xf780, 0xf6c0, 0x3601, 0xf440, 0x3481,
    0x35c1, 0xf500, 0xf140, 0x3181, 0x30c1, 0xf000, 0x3241, 0xf280, 0xf3c0, 0x3301,
    0xfb40, 0x3b81, 0x3ac1, 0xfa00, 0x3841, 0xf880, 0xf9c0, 0x3901, 0x3d41, 0xfd80,
    0xfcc0, 0x3c01, 0xfe40, 0x3e81, 0x3fc1, 0xff00}
};

unsigned crc16usb_byte(unsigned crc, void const *mem, size_t len) {
    unsigned char const *data = mem;
    if (data == NULL)
        return 0;
    crc = ~crc;
    crc &= 0xffff;
    while (len--)
        crc = (crc >> 8) ^
              table_byte[(crc ^ *data++) & 0xff];
    return crc;
}

