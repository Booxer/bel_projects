###############################################################################
##                                                                           ##
##           Common include makefile for native compiling                    ##
##                                                                           ##
##---------------------------------------------------------------------------##
## File:    makefile.native                                                  ##
## (c):     GSI Helmholtz Centre for Heavy Ion Research GmbH                 ##
## Author:  Ulrich Becker                                                    ##
## Date:    22.01.2019                                                       ##
###############################################################################

# TODO: target for install, target for shared library.

CPU     := $(shell uname -m)

CC      = $(GCC_BIN_DIR)gcc -std=c99
CXX     = $(GCC_BIN_DIR)g++ -std=c++11
# -fpermissive
LD      = $(GCC_BIN_DIR)gcc
OBJCPY  = $(GCC_BIN_DIR)objcopy
OBJDUMP = $(GCC_BIN_DIR)objdump
SIZE    = $(GCC_BIN_DIR)size
AS      = $(GCC_BIN_DIR)gcc
AR      = $(GCC_BIN_DIR)gcc-ar rcs
CPP     = $(CC) -E
NM      = $(GCC_BIN_DIR)nm
STRIP   = $(GCC_BIN_DIR)strip
STRINGS = $(GCC_BIN_DIR)strings

ifdef SHARED_OBJECT
  IS_LIBRARY = 1
endif
ifdef STATIC_LIBRARY
  IS_LIBRARY = 1
endif

TARGET   ?= $(notdir $(basename $(MIAN_MODULE)))
BIN_FILE ?= $(TARGET_DIR)/$(TARGET)

LD_FLAGS += $(ARG_LIBS)

DOX_INPUT += $(MAKEFILE_DIR)/makefile.native

include $(MAKEFILE_DIR)/makefile.base

ifndef IS_LIBRARY
$(BIN_FILE): $(OBJ_FILES) $(ADDITIONAL_LD_DEPENDENCES)
	$(LD_F) -o $@ $(OBJ_FILES) $(ADDITIONAL_OBJECTS) $(LD_FLAGS)



ifdef LIB_DIRS
   ADDITIONAL_LIB_PATH = $(addsuffix :,$(LIB_DIRS))
endif

.PHONY: run
run: $(WORK_DIR) $(TARGET_DIR) $(RESULT_FILE)
	$(QUIET)(export LD_LIBRARY_PATH=$(ADDITIONAL_LIB_PATH)$(LD_LIBRARY_PATH); \
	$(BIN_FILE) $(CALL_ARGS) )

ifeq ($(DEBUG), 1)

DEBUG_GUI ?= kdbg

ifdef CALL_ARGS
DBG_ARGS = "-a $(CALL_ARGS)"
endif

.PHONY: dbg
dbg: $(WORK_DIR) $(TARGET_DIR) $(RESULT_FILE)
	$(QUIET)(export LD_LIBRARY_PATH=$(ADDITIONAL_LIB_PATH)$(LD_LIBRARY_PATH); \
	$(DEBUG_GUI) $(BIN_FILE) $(DBG_ARGS))

endif # ifeq ($(DEBUG), 1)

else # ifndef IS_LIBRARY

ifdef STATIC_LIBRARY
$(BIN_FILE): $(OBJ_FILES) $(ADDITIONAL_LD_DEPENDENCES)
	$(AR_F) $(BIN_FILE) $(OBJ_FILES) $(ADDITIONAL_OBJECTS)

endif # ifdef STATIC_LIBRARY
endif # else if ifndef IS_LIBRARY

.PHONY: size
size: $(BIN_FILE)
	$(QUIET)$(SIZE) $(BIN_FILE)

#=================================== EOF ======================================
